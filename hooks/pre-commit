#!/bin/bash
# Pre-commit hook for TextCAD
# Checks code formatting and runs tests before allowing commit
#
# Note: This hook requires the Nix development environment for full functionality.
# If running outside Nix (e.g., in direnv), set SKIP_TESTS=1 to only check formatting.

echo "Running pre-commit checks..."

# Check code formatting (works without Z3)
echo "Checking code formatting with cargo fmt..."
if ! cargo fmt --check 2>&1; then
    echo "❌ Code formatting check failed!"
    echo "Please run 'cargo fmt' to format your code before committing."
    exit 1
fi
echo "✓ Code formatting check passed"

# Run tests if environment supports it
if [ "${SKIP_TESTS}" = "1" ]; then
    echo "⚠ Skipping tests (SKIP_TESTS=1)"
    echo "✅ Formatting check passed!"
    exit 0
fi

echo "Running tests with cargo test..."
# Try with nix develop if nix is available
if command -v nix &> /dev/null; then
    if ! nix develop --command cargo test --quiet 2>&1; then
        echo "❌ Tests failed!"
        echo "Please fix failing tests before committing."
        exit 1
    fi
# Otherwise try direct cargo test (works if already in Nix shell or direnv)
elif cargo test --quiet 2>&1; then
    :  # Success, do nothing
else
    echo "⚠ Warning: Tests could not run (Z3 environment not available)"
    echo "  To run tests, use: nix develop --command cargo test"
    echo "  Or set SKIP_TESTS=1 to suppress this warning"
    echo ""
    echo "Proceeding with commit (formatting passed)..."
fi

echo "✅ All pre-commit checks passed!"
exit 0
